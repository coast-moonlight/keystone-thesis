\documentclass[english, version-2020-11]{uzl-thesis}
\UzLStyle{computer modern oldschool design}
\usepackage{comment}
\usepackage{float}

\input{preamble.tex} % Put your \UzLStyle and \UzLThesisSetup here

\begin{document}

\chapter{Introduction}

Modern computing increasingly relies on platforms that operate in potentially untrusted environments. These include public cloud infrastructures, multi-tenant servers, and distributed edge devices, where sensitive data and critical computations may be exposed to compromised software stacks or malicious actors. In such contexts, ensuring the confidentiality and integrity of both data and execution is a fundamental requirement. Conventional security mechanisms, such as access control and encryption, are often insufficient in scenarios where the underlying operating system, hypervisor, or even firmware may be compromised.

To address these challenges, Trusted Execution Environments (TEEs) have emerged as a compelling solution. TEEs provide hardware-assisted isolation mechanisms that enable the execution of code in a protected context, referred to as an enclave. This enclave is designed to be resilient to attacks originating from untrusted system components, including the operating system and other user-space applications. By establishing a secure boundary around sensitive code and data, TEEs allow developers to implement trustworthy services even on compromised hosts.

Several commercial implementations of TEEs exist today, with Intel Software Guard Extensions (SGX) and ARM TrustZone being the most prominent examples. These technologies have demonstrated the practical viability of hardware-enforced isolation, and they have been integrated into a variety of real-world applications, from digital rights management to secure machine learning inference. However, despite their utility, these solutions are inherently proprietary and closed-source. This lack of transparency imposes significant constraints on researchers, developers, and system architects who wish to investigate alternative TEE designs, customize security mechanisms, or perform formal verification. Moreover, the architectural rigidity of these platforms limits their adaptability to emerging use cases, especially in academic or experimental contexts.

To overcome these limitations, the Keystone framework introduces an open-source, modular TEE architecture built atop the RISC-V instruction set architecture (ISA). RISC-V itself is an open, extensible ISA that has gained significant traction in both academic and industrial settings. Keystone leverages RISC-V's flexibility to enable fine-grained control over enclave behavior and to support a minimal, verifiable trusted computing base (TCB). The framework allows researchers and developers to explore custom enclave policies, experiment with hardware-software co-design, and perform reproducible evaluations in a controlled setting.

This thesis presents a detailed investigation into the Keystone TEE framework. It explores Keystone's architectural foundations, its use of RISC-V hardware features such as Physical Memory Protection (PMP), and its support for dynamic enclave management. Special attention is paid to the performance implications of enclave isolation, as measured through controlled benchmarking in a virtualized environment. By evaluating Keystone under varying execution conditions, this work seeks to provide a rigorous assessment of its efficiency and suitability for secure computation on emerging RISC-V platforms.
\input{chapters/introduction.tex}

\chapter{Background and System Architecture}
The Keystone framework is built on the RISC-V instruction set architecture, which provides a unique foundation for secure system design due to its open specification and modular extensibility. Unlike traditional ISAs that are controlled by single vendors, RISC-V encourages community-driven enhancements and supports custom extensions, making it particularly attractive for trusted computing research and development. Its clean and well-documented privilege model allows for the implementation of isolation mechanisms that are critical to the construction of TEEs.

RISC-V defines three primary privilege levels: user mode (U-mode), supervisor mode (S-mode), and machine mode (M-mode). These privilege levels are hierarchical, with M-mode having the highest authority over system resources. M-mode has direct access to all hardware features and is responsible for critical functions such as interrupt control, exception handling, and access to physical memory protection mechanisms. Keystone leverages this privilege model by placing its Security Monitor (SM)—the core of the TCB—in M-mode. The SM is responsible for managing enclaves, enforcing memory isolation, and mediating access to sensitive system operations. By situating the TCB in M-mode, Keystone ensures that enclave isolation policies are enforced at the highest level of privilege, thereby minimizing the attack surface.

A central hardware feature used by Keystone is Physical Memory Protection (PMP), introduced in version 1.10 of the RISC-V Privilege Specification. PMP enables M-mode software to define access permissions for specific physical memory regions, controlling which lower-privilege modes (U and S) may read, write, or execute code in those regions. This capability forms the basis of Keystone’s memory isolation model. Each enclave is allocated a private memory region protected by PMP, ensuring that neither the host operating system nor any unauthorized software can access its contents. PMP rules are enforced directly by hardware, providing strong guarantees of isolation that are resistant to software-based attacks.

In addition to memory protection, RISC-V supports a flexible trap and exception handling mechanism. M-mode can intercept and handle all traps, but may delegate certain classes of exceptions—such as system calls and page faults—to S-mode for performance optimization. This delegation allows the enclave runtime to cooperate with the host operating system for memory management tasks, while still maintaining strict control over enclave boundaries. The virtual memory subsystem is managed through the standard RISC-V MMU, which translates virtual addresses to physical addresses using multi-level page tables. Keystone leverages this infrastructure to support enclaves that operate with their own private address spaces, protected by PMP from tampering or inspection.

Importantly, the use of standard programming models and toolchains for M-mode software development makes the Keystone Security Monitor both maintainable and extensible. Unlike microcode or hardwired logic, which are difficult to audit and update, the SM is implemented in C and can be subjected to conventional testing and formal verification techniques. This increases the transparency and trustworthiness of the TCB, which is a critical requirement for secure system design.

Taken together, the combination of RISC-V’s privilege hierarchy, PMP, trap delegation mechanisms, and extensibility provides a solid foundation for implementing robust and configurable TEEs. The Keystone framework capitalizes on these features to deliver a flexible and open platform for secure enclave execution, while remaining faithful to the RISC-V philosophy of openness and modularity.

\input{chapters/background.tex}

\chapter{Methodology}
The primary objective of this thesis is to assess the performance impact of Keystone’s enclave isolation mechanisms on typical embedded and systems-level workloads. Specifically, the study seeks to quantify the computational overhead introduced by executing applications within a Keystone enclave, as compared to their execution in a conventional, non-isolated environment. To achieve this, a series of carefully controlled experiments were designed and executed within a virtualized RISC-V system based on QEMU.

All benchmarks were executed in an emulated environment configured for the RV64GC architecture, which is representative of 64-bit RISC-V systems targeted by Keystone. The use of QEMU for emulation allowed for fine-grained control over the system environment, ensured repeatability, and eliminated the variability introduced by physical hardware, such as thermal throttling or hardware-specific optimizations. Although virtualized, the emulation accurately models instruction execution, privilege transitions, memory access patterns, and I/O behavior, making it suitable for preliminary performance evaluation.

To evaluate the impact of enclave execution, each benchmark was implemented as a standalone enclave application (referred to as an “eapp”), accompanied by a corresponding host application that manages enclave lifecycle events. The host application, running in user space, is responsible for initializing the enclave, loading the benchmark binary, invoking enclave entry points, and handling edge calls used for communication between the enclave and the host. The enclave application, in contrast, is isolated by the Keystone runtime and contains only the benchmark logic and internal data structures. This modular separation ensures that the same benchmark code can be executed both natively (without an enclave) and securely (within an enclave) without structural modification, enabling an accurate comparative analysis.

The evaluation involved executing each benchmark—Dhrystone and CoreMark—under two distinct configurations:

\begin{enumerate}
\item \textit{Native Execution:} The benchmark runs as a conventional user-space process within the QEMU-emulated Linux system, without invoking Keystone enclave services.
\item \textit{Enclave Execution:} The benchmark is loaded into a Keystone enclave, with isolation enforced by the Security Monitor using PMP.
\end{enumerate}

Each benchmark was run multiple times (typically ten iterations per configuration) to account for performance variability and ensure statistical robustness. For each run, metrics such as total execution time, throughput (measured in DMIPS for Dhrystone and iterations per second for CoreMark), and standard deviation were collected. The comparative analysis focused on the relative performance degradation observed in the enclave configuration, thereby providing a direct measurement of the cost of security.

This methodology enables a nuanced understanding of how Keystone’s isolation features influence real-world performance metrics. The controlled nature of the test environment, coupled with repeated measurement and the use of industry-standard benchmarks, ensures that the results are both meaningful and reproducible. By isolating the effect of enclave execution, this study contributes valuable insights into the trade-offs between security and efficiency in open-source TEE architectures.
\input{chapters/methodology.tex}

\chapter{Results and discussion}
\input{chapters/results.tex}

\chapter{System Configuration Recommendations}
\input{chapters/recommendations.tex}

\chapter{Conclusion}
%\input{chapters/conclusion.tex}

\begin{bibtex-entries}
@TechReport{Kernighan1974,
author = {Brian Kernighan},
title = {Programming in C – A Tutorial},
institution = {Bell Laboratories},
year = {1974}
}

@article{suzaki2021ts,
  title={Ts-perf: General performance measurement of trusted execution environment and rich execution environment on intel sgx, arm trustzone, and risc-v keystone},
  author={Suzaki, Kuniyasu and Nakajima, Kenta and Oi, Tsukasa and Tsukamoto, Akira},
  journal={IEEE Access},
  volume={9},
  pages={133520--133530},
  year={2021},
  publisher={IEEE}
}

\end{bibtex-entries}
\end{document}